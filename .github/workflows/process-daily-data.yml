name: Process Daily Data - Hourly Sync

on:
  schedule:
    # Ex√©cute toutes les heures √† la minute 0
    - cron: '0 * * * *'
  # Permet √©galement le d√©clenchement manuel depuis l'interface GitHub
  workflow_dispatch:

jobs:
  trigger-daily-data-processing:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Trigger Vercel Function
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          VERCEL_URL: ${{ secrets.VERCEL_URL }}
        run: |
          echo "üöÄ D√©clenchement du traitement des donn√©es..."
          
          response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer ${CRON_SECRET}" \
            -H "Content-Type: application/json" \
            "${VERCEL_URL}/api/process_daily_data")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "üìä Code de r√©ponse HTTP: $http_code"
          echo "üìã R√©ponse:"
          echo "$body" | jq '.' || echo "$body"
          
          # V√©rifier si le code HTTP est un succ√®s (2xx)
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "‚úÖ Traitement d√©clench√© avec succ√®s"
            exit 0
          else
            echo "‚ùå Erreur lors du d√©clenchement"
            exit 1
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è Le cron job a √©chou√©. V√©rifiez les logs ci-dessus."

